@if (startup(); as s) {
  <div class="detail-page">
    <!-- Header -->
    <div class="detail-header">
      <button mat-icon-button (click)="goBack()" matTooltip="Voltar">
        <mat-icon>arrow_back</mat-icon>
      </button>
      @if (s.logo_url) {
        <img
          [src]="s.logo_url"
          [alt]="s.name + ' logo'"
          class="header-logo"
        />
      } @else {
        <mat-icon class="header-logo-fallback">business</mat-icon>
      }
      <div class="header-info">
        <div class="header-name-row">
          @if (editingField() === 'name') {
            <input
              #nameInput
              class="inline-edit inline-edit-name"
              [(ngModel)]="editValue"
              (blur)="saveField('name')"
              (keydown)="onFieldKeydown($event, 'name')"
            />
          } @else {
            <h1 class="startup-name editable" (click)="startEditing('name')">{{ s.name }}</h1>
          }
          @if (s.site) {
            <a
              [href]="s.site"
              target="_blank"
              rel="noopener noreferrer"
              class="header-site-link"
            >
              {{ extractDomain(s.site) }}
              <mat-icon class="header-site-icon">open_in_new</mat-icon>
            </a>
          }
        </div>
        <span class="startup-meta">
          @if (editingField() === 'sector') {
            <input
              #sectorInput
              class="inline-edit inline-edit-meta"
              [(ngModel)]="editValue"
              (blur)="saveField('sector')"
              (keydown)="onFieldKeydown($event, 'sector')"
            />
          } @else {
            <span class="editable" (click)="startEditing('sector')">{{ s.sector }}</span>
          }
          &middot;
          Investimento:
          <span class="editable" (click)="openDatePicker()">{{ s.investment_date | date:'dd/MM/yyyy' }}</span>
          <input
            class="date-hidden-input"
            [matDatepicker]="picker"
            [(ngModel)]="editDateValue"
            (dateChange)="onDateChange($event.value)"
          />
          <mat-datepicker #picker (closed)="onDatePickerClosed()" />
        </span>
      </div>
      <app-status-badge
        [status]="s.status"
        [matMenuTriggerFor]="statusMenu"
        class="status-trigger"
      />
      <mat-menu #statusMenu="matMenu">
        @for (opt of statusOptions; track opt.value) {
          <button mat-menu-item (click)="onStatusChange(opt.value)">
            <mat-icon [style.color]="opt.color">{{ opt.icon }}</mat-icon>
            {{ opt.label }}
          </button>
        }
      </mat-menu>
      <span class="header-spacer"></span>
      <button mat-icon-button matTooltip="Links anteriores" (click)="openTokenListDialog()">
        <mat-icon>history</mat-icon>
      </button>
      <button mat-stroked-button (click)="generateReportToken()">
        <mat-icon>add_link</mat-icon>
        Gerar link
      </button>
      <button mat-stroked-button (click)="openEditStartup()">
        <mat-icon>edit</mat-icon>
        Editar
      </button>
    </div>

    <!-- Resumo Atual -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>Resumo Atual</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Receita Total</span>
            <span class="summary-value">{{ formatCurrency(latestIndicator?.total_revenue ?? 0) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Saldo em Caixa</span>
            <span class="summary-value">{{ formatCurrency(latestIndicator?.cash_balance ?? 0) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">EBITDA/Burn</span>
            <span class="summary-value">{{ formatCurrency(latestIndicator?.ebitda_burn ?? 0) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Headcount</span>
            <span class="summary-value">{{ latestIndicator?.headcount ?? 0 }}</span>
          </div>
        </div>
        @if (latestIndicator; as ind) {
          <p class="summary-period">
            Ref.: {{ monthLabels[ind.month] }}/{{ ind.year }}
          </p>
        }
      </mat-card-content>
    </mat-card>

    <!-- Indicadores Mensais -->
    <mat-expansion-panel class="section-panel" [expanded]="false" [togglePosition]="'before'">
      <mat-expansion-panel-header>
        <mat-panel-title>Indicadores Mensais</mat-panel-title>
        <button mat-stroked-button (click)="openCreateIndicator(); $event.stopPropagation()">
          <mat-icon>add</mat-icon>
          Adicionar
        </button>
      </mat-expansion-panel-header>
      @if (indicators().length === 0) {
        <p class="empty-text">Nenhum indicador cadastrado ainda.</p>
      } @else {
        <table mat-table [dataSource]="indicators()" class="section-table">
          <ng-container matColumnDef="period">
            <th mat-header-cell *matHeaderCellDef>Periodo</th>
            <td mat-cell *matCellDef="let ind">{{ monthLabels[ind.month] }}/{{ ind.year }}</td>
          </ng-container>
          <ng-container matColumnDef="total_revenue">
            <th mat-header-cell *matHeaderCellDef>Receita</th>
            <td mat-cell *matCellDef="let ind">{{ formatCurrency(ind.total_revenue) }}</td>
          </ng-container>
          <ng-container matColumnDef="cash_balance">
            <th mat-header-cell *matHeaderCellDef>Caixa</th>
            <td mat-cell *matCellDef="let ind">{{ formatCurrency(ind.cash_balance) }}</td>
          </ng-container>
          <ng-container matColumnDef="ebitda_burn">
            <th mat-header-cell *matHeaderCellDef>EBITDA/Burn</th>
            <td mat-cell *matCellDef="let ind">{{ formatCurrency(ind.ebitda_burn) }}</td>
          </ng-container>
          <ng-container matColumnDef="headcount">
            <th mat-header-cell *matHeaderCellDef>Headcount</th>
            <td mat-cell *matCellDef="let ind">{{ ind.headcount ?? '-' }}</td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let ind">
              <button mat-icon-button [matMenuTriggerFor]="indMenu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #indMenu="matMenu">
                <button mat-menu-item (click)="openEditIndicator(ind)">
                  <mat-icon>edit</mat-icon> Editar
                </button>
                <button mat-menu-item (click)="deleteIndicator(ind)">
                  <mat-icon color="warn">delete</mat-icon> Excluir
                </button>
              </mat-menu>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="indicatorColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: indicatorColumns"></tr>
        </table>
      }
    </mat-expansion-panel>

    <!-- Reunioes de Conselho -->
    <mat-expansion-panel class="section-panel" [expanded]="false" [togglePosition]="'before'">
      <mat-expansion-panel-header>
        <mat-panel-title>Reunioes de Conselho</mat-panel-title>
        <button mat-stroked-button (click)="openCreateMeeting(); $event.stopPropagation()">
          <mat-icon>add</mat-icon>
          Adicionar
        </button>
      </mat-expansion-panel-header>
      @if (meetings().length === 0) {
        <p class="empty-text">Nenhuma reuniao cadastrada ainda.</p>
      } @else {
        <table mat-table [dataSource]="meetings()" class="section-table">
          <ng-container matColumnDef="meeting_date">
            <th mat-header-cell *matHeaderCellDef>Data</th>
            <td mat-cell *matCellDef="let m">{{ m.meeting_date | date:'dd/MM/yyyy' }}</td>
          </ng-container>
          <ng-container matColumnDef="summary">
            <th mat-header-cell *matHeaderCellDef>Resumo</th>
            <td mat-cell *matCellDef="let m" class="truncate-cell">{{ m.summary ?? '-' }}</td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let m">
              <button mat-icon-button [matMenuTriggerFor]="meetMenu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #meetMenu="matMenu">
                <button mat-menu-item (click)="openEditMeeting(m)">
                  <mat-icon>edit</mat-icon> Editar
                </button>
                <button mat-menu-item (click)="deleteMeeting(m)">
                  <mat-icon color="warn">delete</mat-icon> Excluir
                </button>
              </mat-menu>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="meetingColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: meetingColumns"></tr>
        </table>
      }
    </mat-expansion-panel>

    <!-- Executivos -->
    <mat-expansion-panel class="section-panel" [expanded]="false" [togglePosition]="'before'">
      <mat-expansion-panel-header>
        <mat-panel-title>Executivos</mat-panel-title>
        <button mat-stroked-button (click)="openCreateExecutive(); $event.stopPropagation()">
          <mat-icon>add</mat-icon>
          Adicionar
        </button>
      </mat-expansion-panel-header>
      @if (executives().length === 0) {
        <p class="empty-text">Nenhum executivo cadastrado ainda.</p>
      } @else {
        <table mat-table [dataSource]="executives()" class="section-table">
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Nome</th>
            <td mat-cell *matCellDef="let e">{{ e.name }}</td>
          </ng-container>
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef>Cargo</th>
            <td mat-cell *matCellDef="let e">{{ e.role ?? '-' }}</td>
          </ng-container>
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let e">{{ e.email ?? '-' }}</td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let e">
              <button mat-icon-button [matMenuTriggerFor]="execMenu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #execMenu="matMenu">
                <button mat-menu-item (click)="openEditExecutive(e)">
                  <mat-icon>edit</mat-icon> Editar
                </button>
                <button mat-menu-item (click)="deleteExecutive(e)">
                  <mat-icon color="warn">delete</mat-icon> Excluir
                </button>
              </mat-menu>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="executiveColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: executiveColumns"></tr>
        </table>
      }
    </mat-expansion-panel>
  </div>
}
